{"version":3,"file":"editors.js","sourceRoot":"","sources":["../lib/editors.ts"],"names":[],"mappings":";;;;;AAAA,+BAA0C;AAE1C,sDAA6B;AAC7B,uCAA6E;AAG7E,MAAqB,OAAO;IAM1B;QALA,YAAO,GAAgB,IAAI,GAAG,EAAE,CAAA;QAChC,aAAQ,GAAyB,EAAE,CAAA;QACnC,gBAAW,GAAY,IAAI,CAAA;QAC3B,kBAAa,GAAwB,IAAI,0BAAmB,EAAE,CAAA;QAG5D,IAAI,CAAC,aAAa,CAAC,GAAG,CACpB,IAAI,CAAC,SAAS,CAAC,kBAAkB,CAAC,UAAU,CAAC,EAAE;YAE7C,IAAI,qBAAW,CAAC,UAAU,CAAC,EAAE;gBAC3B,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,sCAAsC,EAAE;oBAClF,MAAM,EACJ,8GAA8G;oBAChH,WAAW,EAAE,IAAI;oBACjB,OAAO,EAAE;wBACP;4BACE,IAAI,EAAE,cAAc;4BACpB,UAAU,EAAE,GAAG,EAAE;gCACf,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAA;gCAC1B,KAAK,CAAC,OAAO,EAAE,CAAA;4BACjB,CAAC;yBACF;wBACD;4BACE,IAAI,EAAE,kBAAkB;4BACxB,UAAU,EAAE,KAAK,IAAI,EAAE;;gCACrB,MAAM,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,0CAA0C,CAAC,CAAA;gCAErE,MAAA,QAAQ,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,CAAC,EAAE,CAAC,0CAAE,cAAc,GAAE;gCACjE,KAAK,CAAC,OAAO,EAAE,CAAA;4BACjB,CAAC;yBACF;qBACF;iBACF,CAAC,CAAA;gBACF,UAAU,CAAC,GAAG,EAAE;oBACd,KAAK,CAAC,OAAO,EAAE,CAAA;gBACjB,CAAC,EAAE,IAAI,CAAC,CAAA;gBACR,OAAM;aACP;YACD,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAA;QAC5B,CAAC,CAAC,EACF,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC,qBAAqB,CAAC,QAAQ,CAAC,EAAE;YAC1D,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;gBAC5B,IAAI,MAAM,CAAC,UAAU,KAAK,QAAQ,EAAE;oBAClC,MAAM,CAAC,aAAa,EAAE,CAAA;iBACvB;YACH,CAAC,CAAC,CAAA;QACJ,CAAC,CAAC,CACH,CAAA;IACH,CAAC;IACD,aAAa;QACX,OAAO,IAAI,CAAC,WAAW,CAAA;IACzB,CAAC;IACD,MAAM,CAAC,EAAE,QAAQ,EAAE,KAAK,EAAE,OAAO,EAAiB;QAChD,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAA;QACxB,IAAI,CAAC,WAAW,GAAG,KAAK,CAAA;QAExB,MAAM,EAAE,UAAU,EAAE,SAAS,EAAE,GAAG,uBAAa,CAAC,IAAI,CAAC,CAAA;QACrD,KAAK,CAAC,OAAO,CAAC,UAAU,OAAO;YAC7B,IAAI,CAAC,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE;gBACjC,OAAM;aACP;YACD,MAAM,QAAQ,GAAG,eAAK,CAAC,OAAO,CAAC,CAAA;YAC/B,IAAI,QAAQ,IAAI,UAAU,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE;gBACxC,UAAU,CAAC,GAAG,CAAC,QAAQ,CAAE,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;aAC9C;QACH,CAAC,CAAC,CAAA;QACF,OAAO,CAAC,OAAO,CAAC,UAAU,OAAO;YAC/B,IAAI,CAAC,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE;gBACjC,OAAM;aACP;YACD,MAAM,QAAQ,GAAG,eAAK,CAAC,OAAO,CAAC,CAAA;YAC/B,IAAI,QAAQ,IAAI,UAAU,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE;gBACxC,UAAU,CAAC,GAAG,CAAC,QAAQ,CAAE,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;aAChD;QACH,CAAC,CAAC,CAAA;QAEF,SAAS,CAAC,OAAO,CAAC,UAAU,QAAQ;YAClC,IAAI,UAAU,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE;gBAC5B,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG,UAAU,CAAC,GAAG,CAAC,QAAQ,CAAiB,CAAA;gBAC5E,IAAI,KAAK,CAAC,MAAM,IAAI,OAAO,CAAC,MAAM,EAAE;oBAClC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,EAAE,OAAO,CAAC,CAAC,CAAA;iBACxD;aACF;QACH,CAAC,CAAC,CAAA;IACJ,CAAC;IACD,SAAS,CAAC,UAAsB;QAC9B,KAAK,MAAM,KAAK,IAAI,IAAI,CAAC,OAAO,EAAE;YAChC,IAAI,KAAK,CAAC,UAAU,KAAK,UAAU,EAAE;gBACnC,OAAO,KAAK,CAAA;aACb;SACF;QACD,MAAM,MAAM,GAAG,IAAI,gBAAM,CAAC,UAAU,CAAC,CAAA;QACrC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,CAAA;QACxB,MAAM,CAAC,YAAY,CAAC,GAAG,EAAE;YACvB,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAA;QAC7B,CAAC,CAAC,CAAA;QACF,MAAM,CAAC,aAAa,CAAC,GAAG,CACtB,UAAU,CAAC,eAAe,CAAC,GAAG,EAAE;YAC9B,MAAM,CAAC,OAAO,EAAE,CAAA;YAChB,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAA;QAC5B,CAAC,CAAC,CACH,CAAA;QACD,MAAM,CAAC,aAAa,CAAC,GAAG,CACtB,UAAU,CAAC,kBAAkB,CAAC,GAAG,EAAE;YACjC,MAAM,CAAC,OAAO,EAAE,CAAA;YAChB,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAA;QAC5B,CAAC,CAAC,CACH,CAAA;QACD,MAAM,CAAC,KAAK,CAAC,wBAAc,CAAC,IAAI,CAAC,QAAQ,EAAE,UAAU,CAAC,OAAO,EAAE,CAAC,EAAE,EAAE,CAAC,CAAA;QACrE,OAAO,MAAM,CAAA;IACf,CAAC;IACD,OAAO;QACL,KAAK,MAAM,KAAK,IAAI,IAAI,CAAC,OAAO,EAAE;YAChC,KAAK,CAAC,OAAO,EAAE,CAAA;SAChB;QACD,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,CAAA;IAC9B,CAAC;CACF;AAtHD,0BAsHC","sourcesContent":["import { CompositeDisposable } from 'atom'\r\nimport type { TextEditor } from 'atom'\r\nimport Editor from './editor'\r\nimport { $file, getEditorsMap, filterMessages, isLargeFile } from './helpers'\r\nimport type { LinterMessage, MessagesPatch, EditorsPatch } from './types'\r\n\r\nexport default class Editors {\r\n  editors: Set<Editor> = new Set()\r\n  messages: Array<LinterMessage> = []\r\n  firstRender: boolean = true\r\n  subscriptions: CompositeDisposable = new CompositeDisposable()\r\n\r\n  constructor() {\r\n    this.subscriptions.add(\r\n      atom.workspace.observeTextEditors(textEditor => {\r\n        // TODO we do this check only at the begining. Probably we should do this later too?\r\n        if (isLargeFile(textEditor)) {\r\n          const notif = atom.notifications.addWarning('Linter: Large/Minified file detected', {\r\n            detail:\r\n              'Adding inline linter markers are skipped for this file for performance reasons (linter pane is still active)',\r\n            dismissable: true,\r\n            buttons: [\r\n              {\r\n                text: 'Force enable',\r\n                onDidClick: () => {\r\n                  this.getEditor(textEditor)\r\n                  notif.dismiss()\r\n                },\r\n              },\r\n              {\r\n                text: 'Change threshold',\r\n                onDidClick: async () => {\r\n                  await atom.workspace.open('atom://config/packages/linter-ui-default')\r\n                  // it is the 16th setting :D\r\n                  document.querySelectorAll('.control-group')[16]?.scrollIntoView()\r\n                  notif.dismiss()\r\n                },\r\n              },\r\n            ],\r\n          })\r\n          setTimeout(() => {\r\n            notif.dismiss()\r\n          }, 5000)\r\n          return\r\n        }\r\n        this.getEditor(textEditor)\r\n      }),\r\n      atom.workspace.getCenter().observeActivePaneItem(paneItem => {\r\n        this.editors.forEach(editor => {\r\n          if (editor.textEditor !== paneItem) {\r\n            editor.removeTooltip()\r\n          }\r\n        })\r\n      }),\r\n    )\r\n  }\r\n  isFirstRender(): boolean {\r\n    return this.firstRender\r\n  }\r\n  update({ messages, added, removed }: MessagesPatch) {\r\n    this.messages = messages\r\n    this.firstRender = false\r\n\r\n    const { editorsMap, filePaths } = getEditorsMap(this)\r\n    added.forEach(function (message) {\r\n      if (!message || !message.location) {\r\n        return\r\n      }\r\n      const filePath = $file(message)\r\n      if (filePath && editorsMap.has(filePath)) {\r\n        editorsMap.get(filePath)!.added.push(message)\r\n      }\r\n    })\r\n    removed.forEach(function (message) {\r\n      if (!message || !message.location) {\r\n        return\r\n      }\r\n      const filePath = $file(message)\r\n      if (filePath && editorsMap.has(filePath)) {\r\n        editorsMap.get(filePath)!.removed.push(message)\r\n      }\r\n    })\r\n\r\n    filePaths.forEach(function (filePath) {\r\n      if (editorsMap.has(filePath)) {\r\n        const { added, removed, editors } = editorsMap.get(filePath) as EditorsPatch\r\n        if (added.length || removed.length) {\r\n          editors.forEach(editor => editor.apply(added, removed))\r\n        }\r\n      }\r\n    })\r\n  }\r\n  getEditor(textEditor: TextEditor): Editor | void {\r\n    for (const entry of this.editors) {\r\n      if (entry.textEditor === textEditor) {\r\n        return entry\r\n      }\r\n    }\r\n    const editor = new Editor(textEditor)\r\n    this.editors.add(editor)\r\n    editor.onDidDestroy(() => {\r\n      this.editors.delete(editor)\r\n    })\r\n    editor.subscriptions.add(\r\n      textEditor.onDidChangePath(() => {\r\n        editor.dispose()\r\n        this.getEditor(textEditor)\r\n      }),\r\n    )\r\n    editor.subscriptions.add(\r\n      textEditor.onDidChangeGrammar(() => {\r\n        editor.dispose()\r\n        this.getEditor(textEditor)\r\n      }),\r\n    )\r\n    editor.apply(filterMessages(this.messages, textEditor.getPath()), [])\r\n    return editor\r\n  }\r\n  dispose() {\r\n    for (const entry of this.editors) {\r\n      entry.dispose()\r\n    }\r\n    this.subscriptions.dispose()\r\n  }\r\n}\r\n"]}