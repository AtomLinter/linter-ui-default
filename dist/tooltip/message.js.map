{"version":3,"file":"message.js","sourceRoot":"","sources":["../../lib/tooltip/message.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as url from 'url'\r\nimport React from 'react'\r\nimport marked from 'marked'\r\n\r\nimport { visitMessage, openExternally, openFile, applySolution, getActiveTextEditor, sortSolutions } from '../helpers'\r\nimport type TooltipDelegate from './delegate'\r\nimport type { Message, LinterMessage } from '../types'\r\nimport FixButton from './fix-button'\r\n\r\nfunction findHref(el: Element | null | undefined): string | null {\r\n  while (el && !el.classList.contains('linter-line')) {\r\n    if (el instanceof HTMLAnchorElement) {\r\n      return el.href\r\n    }\r\n    el = el.parentElement\r\n  }\r\n  return null\r\n}\r\n\r\ntype Props = {\r\n  message: Message\r\n  delegate: TooltipDelegate\r\n}\r\n\r\ntype State = {\r\n  description?: string\r\n  descriptionShow?: boolean\r\n}\r\n\r\nexport default class MessageElement extends React.Component<Props, State> {\r\n  state: State = {\r\n    description: '',\r\n    descriptionShow: false,\r\n  }\r\n\r\n  componentDidMount() {\r\n    this.props.delegate.onShouldUpdate(() => {\r\n      this.setState({})\r\n    })\r\n    this.props.delegate.onShouldExpand(() => {\r\n      if (!this.state.descriptionShow) {\r\n        this.toggleDescription()\r\n      }\r\n    })\r\n    this.props.delegate.onShouldCollapse(() => {\r\n      if (this.state.descriptionShow) {\r\n        this.toggleDescription()\r\n      }\r\n    })\r\n  }\r\n\r\n  onFixClick(): void {\r\n    const message = this.props.message\r\n    const textEditor = getActiveTextEditor()\r\n    if (message.version === 2 && message.solutions && message.solutions.length) {\r\n      applySolution(textEditor, sortSolutions(message.solutions)[0])\r\n    }\r\n  }\r\n\r\n  openFile(ev: Event) {\r\n    if (!(ev.target instanceof HTMLElement)) {\r\n      return\r\n    }\r\n    const href = findHref(ev.target)\r\n    if (!href) {\r\n      return\r\n    }\r\n    // parse the link. e.g. atom://linter?file=<path>&row=<number>&column=<number>\r\n    const { protocol, hostname, query } = url.parse(href, true)\r\n    if (protocol !== 'atom:' || hostname !== 'linter') {\r\n      return\r\n    }\r\n    // TODO: based on the types query is never null\r\n    if (!query || !query.file) {\r\n      return\r\n    } else {\r\n      const { file, row, column } = query\r\n      // TODO: will these be an array?\r\n      openFile(\r\n        /* file */ Array.isArray(file) ? file[0] : file,\r\n        /* position */ {\r\n          row: parseInt(Array.isArray(row) ? row[0] : row, 10) || 0,\r\n          column: parseInt(Array.isArray(column) ? column[0] : column, 10) || 0,\r\n        },\r\n      )\r\n    }\r\n  }\r\n\r\n  canBeFixed(message: LinterMessage): boolean {\r\n    if (message.version === 2 && message.solutions && message.solutions.length) {\r\n      return true\r\n    }\r\n    return false\r\n  }\r\n\r\n  toggleDescription(result: string | null | undefined = null) {\r\n    const newStatus = !this.state.descriptionShow\r\n    const description = this.state.description || this.props.message.description\r\n\r\n    if (!newStatus && !result) {\r\n      this.setState({ descriptionShow: false })\r\n      return\r\n    }\r\n    if (typeof description === 'string' || result) {\r\n      const descriptionToUse = marked(result || (description as string))\r\n      this.setState({ descriptionShow: true, description: descriptionToUse })\r\n    } else if (typeof description === 'function') {\r\n      this.setState({ descriptionShow: true })\r\n      if (this.descriptionLoading) {\r\n        return\r\n      }\r\n      this.descriptionLoading = true\r\n      new Promise(function (resolve) {\r\n        resolve(description())\r\n      })\r\n        .then(response => {\r\n          if (typeof response !== 'string') {\r\n            throw new Error(`Expected result to be string, got: ${typeof response}`)\r\n          }\r\n          this.toggleDescription(response)\r\n        })\r\n        .catch(error => {\r\n          console.log('[Linter] Error getting descriptions', error)\r\n          this.descriptionLoading = false\r\n          if (this.state.descriptionShow) {\r\n            this.toggleDescription()\r\n          }\r\n        })\r\n    } else {\r\n      console.error('[Linter] Invalid description detected, expected string or function but got:', typeof description)\r\n    }\r\n  }\r\n\r\n  descriptionLoading = false\r\n\r\n  render() {\r\n    const { message, delegate } = this.props\r\n\r\n    return (\r\n      <linter-message class={message.severity} onClick={this.openFile}>\r\n        {message.description && (\r\n          <a href=\"#\" onClick={() => this.toggleDescription()}>\r\n            <span className={`icon linter-icon icon-${this.state.descriptionShow ? 'chevron-down' : 'chevron-right'}`} />\r\n          </a>\r\n        )}\r\n        <linter-excerpt>\r\n          {this.canBeFixed(message) && <FixButton onClick={() => this.onFixClick()} />}\r\n          {delegate.showProviderName ? `${message.linterName}: ` : ''}\r\n          {message.excerpt}\r\n        </linter-excerpt>{' '}\r\n        {message.reference && message.reference.file && (\r\n          <a href=\"#\" onClick={() => visitMessage(message, true)}>\r\n            <span className=\"icon linter-icon icon-alignment-aligned-to\" />\r\n          </a>\r\n        )}\r\n        {message.url && (\r\n          <a href=\"#\" onClick={() => openExternally(message)}>\r\n            <span className=\"icon linter-icon icon-link\" />\r\n          </a>\r\n        )}\r\n        {this.state.descriptionShow && (\r\n          <div\r\n            dangerouslySetInnerHTML={{\r\n              __html: this.state.description || 'Loading...',\r\n            }}\r\n            className=\"linter-line\"\r\n          />\r\n        )}\r\n      </linter-message>\r\n    )\r\n  }\r\n}\r\n"]}