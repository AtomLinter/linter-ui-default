{"version":3,"file":"index.js","sourceRoot":"","sources":["../../lib/editor/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { debounce } from 'lodash'\r\nimport disposableEvent from 'disposable-event'\r\nimport { CompositeDisposable, Disposable, Emitter, Range } from 'atom'\r\ntype CompositeDisposableType = CompositeDisposable & { disposed: boolean }\r\n\r\n// $FlowIgnore: Cursor is a type\r\nimport type { TextEditor, DisplayMarker, Marker, Gutter, Point, Cursor } from 'atom'\r\n\r\nimport Tooltip from '../tooltip'\r\nimport { $range, filterMessagesByRangeOrPoint } from '../helpers'\r\nimport { hasParent, mouseEventNearPosition, getBufferPositionFromMouseEvent } from './helpers'\r\nimport type { LinterMessage } from '../types'\r\n\r\nexport default class Editor {\r\n  gutter: Gutter | null | undefined\r\n  tooltip: Tooltip | null | undefined\r\n  emitter: Emitter\r\n  markers: Map<string, Array<DisplayMarker | Marker>>\r\n  messages: Map<string, LinterMessage>\r\n  textEditor: TextEditor\r\n  showTooltip: boolean\r\n  subscriptions: CompositeDisposableType\r\n  cursorPosition: Point | null | undefined\r\n  gutterPosition: string\r\n  tooltipFollows: string\r\n  showDecorations: boolean\r\n  showProviderName: boolean\r\n  ignoreTooltipInvocation: boolean\r\n  currentLineMarker: DisplayMarker | null | undefined\r\n  lastRange: Range | null | undefined\r\n  lastIsEmpty: boolean | null | undefined\r\n  lastCursorPositions: WeakMap<Cursor, Point>\r\n\r\n  constructor(textEditor: TextEditor) {\r\n    this.tooltip = null\r\n    this.emitter = new Emitter()\r\n    this.markers = new Map()\r\n    this.messages = new Map()\r\n    this.textEditor = textEditor\r\n    this.subscriptions = new CompositeDisposable() as CompositeDisposableType\r\n    this.ignoreTooltipInvocation = false\r\n    this.currentLineMarker = null\r\n    this.lastRange = null\r\n    this.lastIsEmpty = null\r\n    this.lastCursorPositions = new WeakMap()\r\n\r\n    this.subscriptions.add(this.emitter)\r\n    this.subscriptions.add(\r\n      atom.config.observe('linter-ui-default.showTooltip', showTooltip => {\r\n        this.showTooltip = showTooltip\r\n        if (!this.showTooltip && this.tooltip) {\r\n          this.removeTooltip()\r\n        }\r\n      }),\r\n    )\r\n    this.subscriptions.add(\r\n      atom.config.observe('linter-ui-default.showProviderName', showProviderName => {\r\n        this.showProviderName = showProviderName\r\n      }),\r\n    )\r\n    this.subscriptions.add(\r\n      atom.config.observe('linter-ui-default.showDecorations', showDecorations => {\r\n        const notInitial = typeof this.showDecorations !== 'undefined'\r\n        this.showDecorations = showDecorations\r\n        if (notInitial) {\r\n          this.updateGutter()\r\n        }\r\n      }),\r\n    )\r\n    this.subscriptions.add(\r\n      atom.config.observe('linter-ui-default.gutterPosition', gutterPosition => {\r\n        const notInitial = typeof this.gutterPosition !== 'undefined'\r\n        this.gutterPosition = gutterPosition\r\n        if (notInitial) {\r\n          this.updateGutter()\r\n        }\r\n      }),\r\n    )\r\n    this.subscriptions.add(\r\n      textEditor.onDidDestroy(() => {\r\n        this.dispose()\r\n      }),\r\n    )\r\n\r\n    let tooltipSubscription: CompositeDisposable | null = null\r\n    this.subscriptions.add(\r\n      atom.config.observe('linter-ui-default.tooltipFollows', tooltipFollows => {\r\n        this.tooltipFollows = tooltipFollows\r\n        if (tooltipSubscription) {\r\n          tooltipSubscription.dispose()\r\n        }\r\n        tooltipSubscription = new CompositeDisposable()\r\n        if (tooltipFollows === 'Mouse' || tooltipFollows === 'Both') {\r\n          tooltipSubscription.add(this.listenForMouseMovement())\r\n        }\r\n        if (tooltipFollows === 'Keyboard' || tooltipFollows === 'Both') {\r\n          tooltipSubscription.add(this.listenForKeyboardMovement())\r\n        }\r\n        this.removeTooltip()\r\n      }),\r\n    )\r\n    this.subscriptions.add(\r\n      new Disposable(function () {\r\n        tooltipSubscription.dispose()\r\n      }),\r\n    )\r\n\r\n    this.subscriptions.add(\r\n      textEditor.onDidChangeCursorPosition(({ cursor, newBufferPosition }) => {\r\n        const lastBufferPosition = this.lastCursorPositions.get(cursor)\r\n        if (!lastBufferPosition || !lastBufferPosition.isEqual(newBufferPosition)) {\r\n          this.lastCursorPositions.set(cursor, newBufferPosition)\r\n          this.ignoreTooltipInvocation = false\r\n        }\r\n        if (this.tooltipFollows === 'Mouse') {\r\n          this.removeTooltip()\r\n        }\r\n      }),\r\n    )\r\n    this.subscriptions.add(\r\n      textEditor.getBuffer().onDidChangeText(() => {\r\n        const cursors = textEditor.getCursors()\r\n        cursors.forEach(cursor => {\r\n          this.lastCursorPositions.set(cursor, cursor.getBufferPosition())\r\n        })\r\n        if (this.tooltipFollows !== 'Mouse') {\r\n          this.ignoreTooltipInvocation = true\r\n          this.removeTooltip()\r\n        }\r\n      }),\r\n    )\r\n    this.updateGutter()\r\n    this.listenForCurrentLine()\r\n  }\r\n  listenForCurrentLine() {\r\n    this.subscriptions.add(\r\n      this.textEditor.observeCursors(cursor => {\r\n        const handlePositionChange = ({ start, end }) => {\r\n          const gutter = this.gutter\r\n          if (!gutter || this.subscriptions.disposed) return\r\n          // We need that Range.fromObject hack below because when we focus index 0 on multi-line selection\r\n          // end.column is the column of the last line but making a range out of two and then accesing\r\n          // the end seems to fix it (black magic?)\r\n          const currentRange = Range.fromObject([start, end])\r\n          const linesRange = Range.fromObject([\r\n            [start.row, 0],\r\n            [end.row, Infinity],\r\n          ])\r\n          const currentIsEmpty = currentRange.isEmpty()\r\n\r\n          // NOTE: Atom does not paint gutter if multi-line and last line has zero index\r\n          if (start.row !== end.row && currentRange.end.column === 0) {\r\n            linesRange.end.row--\r\n          }\r\n          if (this.lastRange && this.lastRange.isEqual(linesRange) && currentIsEmpty === this.lastIsEmpty) return\r\n          if (this.currentLineMarker) {\r\n            this.currentLineMarker.destroy()\r\n            this.currentLineMarker = null\r\n          }\r\n          this.lastRange = linesRange\r\n          this.lastIsEmpty = currentIsEmpty\r\n\r\n          this.currentLineMarker = this.textEditor.markScreenRange(linesRange, {\r\n            invalidate: 'never',\r\n          })\r\n          const item = document.createElement('span')\r\n          item.className = `line-number cursor-line linter-cursor-line ${currentIsEmpty ? 'cursor-line-no-selection' : ''}`\r\n          gutter.decorateMarker(this.currentLineMarker, {\r\n            item,\r\n            class: 'linter-row',\r\n          })\r\n        }\r\n\r\n        const cursorMarker = cursor.getMarker()\r\n        const subscriptions = new CompositeDisposable()\r\n        subscriptions.add(\r\n          cursorMarker.onDidChange(({ newHeadScreenPosition, newTailScreenPosition }) => {\r\n            handlePositionChange({\r\n              start: newHeadScreenPosition,\r\n              end: newTailScreenPosition,\r\n            })\r\n          }),\r\n        )\r\n        subscriptions.add(\r\n          cursor.onDidDestroy(() => {\r\n            this.subscriptions.remove(subscriptions)\r\n            subscriptions.dispose()\r\n          }),\r\n        )\r\n        subscriptions.add(\r\n          new Disposable(function () {\r\n            if (this.currentLineMarker) {\r\n              this.currentLineMarker.destroy()\r\n              this.currentLineMarker = null\r\n            }\r\n          }),\r\n        )\r\n        this.subscriptions.add(subscriptions)\r\n        handlePositionChange(cursorMarker.getScreenRange())\r\n      }),\r\n    )\r\n  }\r\n  listenForMouseMovement() {\r\n    const editorElement = atom.views.getView(this.textEditor)\r\n\r\n    return disposableEvent(\r\n      editorElement,\r\n      'mousemove',\r\n      debounce(\r\n        event => {\r\n          if (!editorElement.getComponent() || this.subscriptions.disposed || !hasParent(event.target, 'div.scroll-view')) {\r\n            return\r\n          }\r\n          const tooltip = this.tooltip\r\n          if (\r\n            tooltip &&\r\n            mouseEventNearPosition({\r\n              event,\r\n              editor: this.textEditor,\r\n              editorElement,\r\n              tooltipElement: tooltip.element,\r\n              screenPosition: tooltip.marker.getStartScreenPosition(),\r\n            })\r\n          ) {\r\n            return\r\n          }\r\n\r\n          this.cursorPosition = getBufferPositionFromMouseEvent(event, this.textEditor, editorElement)\r\n          this.ignoreTooltipInvocation = false\r\n          //@ts-ignore internal API\r\n          if (this.textEditor.largeFileMode || this.textEditor.getLineCount() > 20000) {\r\n            // TODO: make line count a config\r\n            // NOTE: Ignore if file is too large\r\n            this.cursorPosition = null\r\n          }\r\n          if (this.cursorPosition) {\r\n            this.updateTooltip(this.cursorPosition)\r\n          } else {\r\n            this.removeTooltip()\r\n          }\r\n        },\r\n        300,\r\n        true,\r\n      ),\r\n    )\r\n  }\r\n  listenForKeyboardMovement() {\r\n    return this.textEditor.onDidChangeCursorPosition(\r\n      debounce(({ newBufferPosition }) => {\r\n        this.cursorPosition = newBufferPosition\r\n        this.updateTooltip(newBufferPosition)\r\n      }, 16),\r\n    )\r\n  }\r\n  updateGutter() {\r\n    this.removeGutter()\r\n    if (!this.showDecorations) {\r\n      this.gutter = null\r\n      return\r\n    }\r\n    const priority = this.gutterPosition === 'Left' ? -100 : 100\r\n    this.gutter = this.textEditor.addGutter({\r\n      name: 'linter-ui-default',\r\n      priority,\r\n    })\r\n    this.markers.forEach((markers: Array<DisplayMarker>, key: string) => {\r\n      const message = this.messages.get(key)\r\n      if (message) {\r\n        for (const marker of markers) {\r\n          this.decorateMarker(message, marker, 'gutter')\r\n        }\r\n      }\r\n    })\r\n  }\r\n  removeGutter() {\r\n    if (this.gutter) {\r\n      try {\r\n        this.gutter.destroy()\r\n      } catch (_) {\r\n        /* This throws when the text editor is disposed */\r\n      }\r\n    }\r\n  }\r\n  updateTooltip(position: Point | null | undefined) {\r\n    if (!position || (this.tooltip && this.tooltip.isValid(position, this.messages))) {\r\n      return\r\n    }\r\n    this.removeTooltip()\r\n    if (!this.showTooltip) {\r\n      return\r\n    }\r\n    if (this.ignoreTooltipInvocation) {\r\n      return\r\n    }\r\n\r\n    const messages = filterMessagesByRangeOrPoint(this.messages, this.textEditor.getPath(), position)\r\n    if (!messages.length) {\r\n      return\r\n    }\r\n\r\n    this.tooltip = new Tooltip(messages, position, this.textEditor)\r\n\r\n    // save markers of the tooltip (for destorying them in this.apply)\r\n    messages.forEach(message => {\r\n      // $FlowIgnore: this.tooltip is not null\r\n      this.saveMarker(message.key, this.tooltip.marker)\r\n    })\r\n\r\n    // $FlowIgnore: this.tooltip is not null\r\n    this.tooltip.onDidDestroy(() => {\r\n      this.tooltip = null\r\n    })\r\n  }\r\n  removeTooltip() {\r\n    if (this.tooltip) {\r\n      this.tooltip.marker.destroy()\r\n    }\r\n  }\r\n  apply(added: Array<LinterMessage>, removed: Array<LinterMessage>) {\r\n    const textBuffer = this.textEditor.getBuffer()\r\n\r\n    for (let i = 0, length = removed.length; i < length; i++) {\r\n      const message = removed[i]\r\n      this.destroyMarker(message.key)\r\n    }\r\n\r\n    for (let i = 0, length = added.length; i < length; i++) {\r\n      const message = added[i]\r\n      const markerRange = $range(message)\r\n      if (!markerRange) {\r\n        // Only for backward compatibility\r\n        continue\r\n      }\r\n      // TODO this marker is Marker no DisplayMarker!!\r\n      const marker: Marker = textBuffer.markRange(markerRange, {\r\n        invalidate: 'never',\r\n      })\r\n      this.decorateMarker(message, marker)\r\n      marker.onDidChange(({ oldHeadPosition, newHeadPosition, isValid }) => {\r\n        if (!isValid || (newHeadPosition.row === 0 && oldHeadPosition.row !== 0)) {\r\n          return\r\n        }\r\n        if (message.version === 2) {\r\n          message.location.position = marker.previousEventState.range\r\n        }\r\n      })\r\n    }\r\n\r\n    this.updateTooltip(this.cursorPosition)\r\n  }\r\n  decorateMarker(message: LinterMessage, marker: DisplayMarker | Marker, paint: 'gutter' | 'editor' | 'both' = 'both') {\r\n    this.saveMarker(message.key, marker)\r\n    this.messages.set(message.key, message)\r\n\r\n    if (paint === 'both' || paint === 'editor') {\r\n      this.textEditor.decorateMarker(marker, {\r\n        type: 'text',\r\n        class: `linter-highlight linter-${message.severity}`,\r\n      })\r\n    }\r\n\r\n    const gutter = this.gutter\r\n    if (gutter && (paint === 'both' || paint === 'gutter')) {\r\n      const element = document.createElement('span')\r\n      element.className = `linter-gutter linter-gutter-${message.severity} icon icon-${message.icon || 'primitive-dot'}`\r\n      gutter.decorateMarker(marker, {\r\n        class: 'linter-row',\r\n        item: element,\r\n      })\r\n    }\r\n  }\r\n\r\n  // add marker to the message => marker map\r\n  saveMarker(key: string, marker: DisplayMarker | Marker) {\r\n    const allMarkers = this.markers.get(key) || []\r\n    allMarkers.push(marker)\r\n    this.markers.set(key, allMarkers)\r\n  }\r\n\r\n  // destroy markers of a key\r\n  destroyMarker(key: string) {\r\n    const markers = this.markers.get(key)\r\n    if (markers) {\r\n      markers.forEach(marker => {\r\n        if (marker) {\r\n          marker.destroy()\r\n        }\r\n      })\r\n    }\r\n    this.markers.delete(key)\r\n    this.messages.delete(key)\r\n  }\r\n\r\n  onDidDestroy(callback: (value?: any) => void) {\r\n    return this.emitter.on('did-destroy', callback)\r\n  }\r\n  dispose() {\r\n    this.emitter.emit('did-destroy')\r\n    this.subscriptions.dispose()\r\n    this.removeGutter()\r\n    this.removeTooltip()\r\n  }\r\n}\r\n"]}